{% extends 'base.html' %}

{% block title %}Mensajes | SWCAT{% endblock %}

{% block content %}

<main class="container-fluid mt-5 mb-5">

    <!-- Chat Container -->
    <div id="chat-container" class="bg-light p-3 my-4 rounded">
        <div id="chat" class="overflow-auto">
            <!-- Mensajes se cargarán dinámicamente aquí -->
        </div>
    </div>

    <form id="mensaje-form" class="mt-3">
        {% csrf_token %}
        <div class="input-group">
            <input type="text" name="contenido" id="user-input" class="form-control" placeholder="Escribe tu mensaje..."
                required>
            <div class="input-group-append">
                <button type="button" class="btn btn-primary" style="background-color: #0047B6;"
                    id="enviar-btn">Enviar</button>
            </div>
        </div>
    </form>

    {% if es_grupal_bool %}
    <a href="{% url 'detalle_tutoriaGrupal' id_tutoria_grupal.idTutoriaGrupal %}"
        class="btn btn-outline-secondary back-button" style="margin-top: 20px;">
        Regresar
    </a>
    {% else %}
    <a href="{% url 'detalle_tutoriaIndividual' id_tutoria_individual.idTutoriaIndividual %}"
        class="btn btn-outline-secondary back-button" style="margin-top: 20px;">
        Regresar
    </a>
    {% endif %}


    <script>
        function cargarMensajes() {
            $.ajax({
                url: '{% url "obtener_mensajes" tutor_id=tutor.idTutor tutorado_id=tutorado.idTutorado es_grupal=es_grupal_bool %}',
                method: 'GET',
                success: function (data) {
                    $('#chat').empty();
                    data.mensajes.forEach(function (mensaje) {
                        var claseMensaje = mensaje.tutorEnvia ? 'tutor' : 'tutorado';
                        var contenido = mensaje.tutorEnvia ? '<strong>{{ tutor.nombre }} {{ tutor.apellidoPaterno }} {{ tutor.apellidoMaterno }}</strong>' : '<strong>{{ tutorado.nombre }} {{ tutorado.apellidoPaterno }} {{ tutorado.apellidoMaterno }}</strong>';
                        contenido += ': ' + mensaje.contenido + '<small class="text-muted">' + mensaje.fecha_envio + '</small>';
                        $('#chat').append('<div class="message ' + claseMensaje + '">' + contenido + '</div>');
                    });
                    scrollToBottom();
                },
                error: function (error) {
                    console.error('Error al cargar mensajes: ', error);
                }
            });
        }

        function enviarMensaje() {
            var contenido = $('#user-input').val();
            if (contenido) {
                var csrf_token = $('input[name=csrfmiddlewaretoken]').val();  // Obtener el token CSRF del formulario
                $.ajax({
                    url: '{% url "enviar_mensaje" tutor_id=tutor.idTutor tutorado_id=tutorado.idTutorado es_grupal=es_grupal_bool %}',
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrf_token },  // Incluir el token CSRF en las cabeceras
                    data: { contenido: contenido },
                    success: function () {
                        $('#user-input').val('');
                        cargarMensajes();
                    },
                    error: function (error) {
                        console.error('Error al enviar mensaje: ', error);
                    }
                });
            }
        }


        $(document).ready(function () {
            cargarMensajes();
        });

        setInterval(cargarMensajes, 5000);

        $('#enviar-btn').on('click', function () {
            enviarMensaje();
        });

        $('#mensaje-form').on('submit', function (event) {
            event.preventDefault();
            enviarMensaje();
        });

        function scrollToBottom() {
            var chatContainer = document.getElementById('chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    </script>

</main>

<style>
    .message {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 8px;
    }

    .tutor {
        background-color: #cce5ff;
    }

    .tutorado {
        background-color: #e6ffe6;
    }

    #chat-container {
        max-height: 300px;
        overflow-y: auto;
    }
</style>

{% endblock %}